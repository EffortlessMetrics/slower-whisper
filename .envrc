# direnv configuration for slower-whisper
# Automatically activates Nix dev shell when entering project directory
#
# Setup:
#   1. Install direnv: https://direnv.net/docs/installation.html
#   2. Run: direnv allow
#
# This will automatically load the Nix development environment when you cd
# into this directory.

# Watch flake files for automatic reload on changes
watch_file flake.nix
watch_file flake.lock

# Custom use_flake that cleans the dynamic-linker environment BEFORE calling nix.
# Standard 'use flake' calls `nix print-dev-env` internally, but that nix process
# inherits the current shell's LD_LIBRARY_PATH. If we're re-entering from a previous
# devshell, the libstdc++.so.6 from gcc (for numpy/torch) breaks nix with:
#   /nix/store/.../nix: .../libstdc++.so.6: version `CXXABI_1.3.15' not found
#
# Solution: override use_flake to run nix with a clean environment.
use_flake_clean() {
    # Clear linker variables before nix runs
    unset LD_LIBRARY_PATH
    unset LD_PRELOAD
    unset NIX_LD
    unset NIX_LD_LIBRARY_PATH
    unset DYLD_LIBRARY_PATH
    unset DYLD_FALLBACK_LIBRARY_PATH

    # Call the real use_flake (nix runs in clean env now)
    use flake "$@"

    # Note: we don't restore the old values - the flake's shellHook
    # will set the correct LD_LIBRARY_PATH for this devshell
}

use_flake_clean

# Optional: Load .env file if it exists (for HF_TOKEN, etc.)
if [ -f .env ]; then
  dotenv .env
fi
