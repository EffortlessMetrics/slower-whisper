{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/EffortlessMetrics/slower-whisper/schemas/pr-dossier-v2.schema.json",
  "title": "PR Dossier Schema v2",
  "description": "Schema for structured PR analysis dossiers",
  "type": "object",
  "required": ["schema_version", "pr_number", "title", "url", "created_at"],
  "properties": {
    "inputs": {
      "type": "object",
      "description": "Data sources available for analysis",
      "properties": {
        "coverage": {
          "type": "string",
          "enum": ["github_only", "github_plus_claude"],
          "description": "What data sources were available for analysis"
        },
        "missing_sources": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Data sources that were not available (e.g., claude_session_log)"
        }
      }
    },
    "decision_events": {
      "type": "array",
      "description": "Control-plane decisions that drove the PR",
      "items": {
        "type": "object",
        "required": ["type", "description", "anchor", "confidence", "minutes_lb", "minutes_ub"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["scope", "design", "quality", "debug", "publish"],
            "description": "Decision category"
          },
          "description": {
            "type": "string",
            "description": "What the decision was"
          },
          "anchor": {
            "type": "string",
            "description": "Evidence anchor (commit SHA, comment URL, issue link)"
          },
          "confidence": {
            "type": "string",
            "enum": ["high", "med", "low"],
            "description": "Confidence in this inference"
          },
          "minutes_lb": {
            "type": "integer",
            "description": "Lower bound estimate in minutes"
          },
          "minutes_ub": {
            "type": "integer",
            "description": "Upper bound estimate in minutes"
          }
        }
      }
    },
    "schema_version": {
      "type": "integer",
      "const": 2,
      "description": "Schema version (must be 2)"
    },
    "pr_number": {
      "type": "integer",
      "description": "GitHub PR number"
    },
    "title": {
      "type": "string",
      "description": "PR title"
    },
    "url": {
      "type": "string",
      "format": "uri",
      "description": "PR URL"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "PR creation timestamp"
    },
    "merged_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "PR merge timestamp (null if not merged)"
    },
    "intent": {
      "type": "object",
      "properties": {
        "goal": {
          "type": "string",
          "description": "1-2 sentence description of PR goal"
        },
        "issues": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Linked issue numbers"
        },
        "phase": {
          "type": "string",
          "description": "Roadmap phase (v1.9, v2.0-track1, etc.)"
        },
        "type": {
          "type": "string",
          "enum": ["feature", "hardening", "mechanization", "perf/bench", "refactor", "unknown"],
          "description": "PR type category"
        },
        "out_of_scope": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Explicit exclusions"
        }
      }
    },
    "scope": {
      "type": "object",
      "properties": {
        "files_changed": {"type": "integer"},
        "insertions": {"type": "integer"},
        "deletions": {"type": "integer"},
        "top_directories": {
          "type": "array",
          "items": {"type": "string"}
        },
        "key_files": {
          "type": "array",
          "items": {"type": "string"}
        },
        "blast_radius": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        }
      }
    },
    "findings": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "description"],
        "properties": {
          "type": {
            "type": "string",
            "description": "Failure mode type from FAILURE_MODES.md"
          },
          "description": {"type": "string"},
          "detected_by": {
            "type": "string",
            "enum": ["gate", "review", "post-merge", "self", "DocsSchemaAuditor"]
          },
          "disposition": {"type": "string"},
          "commit": {"type": ["string", "null"]},
          "prevention_added": {"type": ["string", "null"]}
        }
      }
    },
    "evidence": {
      "type": "object",
      "properties": {
        "local_gate": {
          "type": "object",
          "properties": {
            "passed": {"type": "boolean"},
            "command": {"type": "string"},
            "receipt_path": {"type": ["string", "null"]}
          }
        },
        "tests": {
          "type": "object",
          "properties": {
            "added": {"type": "integer"},
            "modified": {"type": "integer"},
            "path": {"type": ["string", "null"]},
            "coverage_delta": {"type": ["number", "null"]}
          }
        },
        "typing": {
          "type": "object",
          "properties": {
            "mypy_passed": {"type": "boolean"},
            "ruff_passed": {"type": "boolean"}
          }
        },
        "benchmarks": {
          "type": "object",
          "properties": {
            "results_path": {"type": ["string", "null"]},
            "metrics": {"type": "object"},
            "baseline_commit": {"type": ["string", "null"]},
            "semantics_unchanged": {"type": ["boolean", "string"]}
          }
        },
        "docs_updated": {"type": "boolean"},
        "schema_validated": {"type": ["boolean", "string"]}
      }
    },
    "process": {
      "type": "object",
      "properties": {
        "friction_events": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "event": {"type": "string"},
              "detected_by": {"type": "string"},
              "disposition": {"type": "string"},
              "prevention": {"type": ["string", "null"]}
            }
          }
        },
        "design_alignment": {
          "type": "object",
          "properties": {
            "drifted": {"type": "boolean"},
            "notes": {"type": ["string", "null"]}
          }
        },
        "measurement_integrity": {
          "type": "object",
          "properties": {
            "valid": {"type": ["boolean", "string"]},
            "invalidation_reason": {"type": ["string", "null"]},
            "correction_link": {"type": ["string", "null"]}
          }
        },
        "temporal": {
          "type": "object",
          "description": "Temporal topology analysis of PR evolution - tracks how the PR progressed through phases, identifies churn hotspots, and detects oscillation patterns that indicate uncertainty or rework",
          "properties": {
            "method_id": {
              "type": "string",
              "description": "Algorithm version identifier for reproducibility (e.g., 'temporal-v1.1')"
            },
            "confidence": {
              "type": "string",
              "enum": ["high", "medium", "low"],
              "description": "Overall confidence in the analysis based on data quality"
            },
            "convergence_type": {
              "type": "string",
              "enum": ["linear", "cyclical", "chaotic"],
              "description": "Overall pattern of how the PR converged: linear (smooth progression), cyclical (oscillations but eventual convergence), chaotic (many phase transitions)"
            },
            "phases": {
              "type": "array",
              "description": "Ordered sequence of development phases detected in the PR commit history",
              "items": {
                "type": "object",
                "required": ["name", "start_commit", "end_commit", "evidence", "session_type"],
                "properties": {
                  "name": {
                    "type": "string",
                    "enum": ["exploration", "oscillation", "lock-in"],
                    "description": "Phase type: exploration (initial work), oscillation (back-and-forth changes), lock-in (final convergence)"
                  },
                  "start_commit": {
                    "type": "string",
                    "description": "First commit SHA in this phase"
                  },
                  "end_commit": {
                    "type": "string",
                    "description": "Last commit SHA in this phase"
                  },
                  "evidence": {
                    "type": "string",
                    "description": "Human-readable explanation of why this phase was detected"
                  },
                  "session_type": {
                    "type": "string",
                    "enum": ["build-loop", "publish-loop", "docs-loop"],
                    "description": "Primary activity type: build-loop (implementation), publish-loop (release prep), docs-loop (documentation)"
                  }
                }
              }
            },
            "hotspots": {
              "type": "array",
              "description": "Files with high churn that may indicate design uncertainty or complexity",
              "items": {
                "type": "object",
                "required": ["file", "touch_count", "churn_sum", "is_oscillating"],
                "properties": {
                  "file": {
                    "type": "string",
                    "description": "File path relative to repository root"
                  },
                  "touch_count": {
                    "type": "integer",
                    "description": "Number of commits that modified this file"
                  },
                  "churn_sum": {
                    "type": "integer",
                    "description": "Total lines added + deleted across all commits"
                  },
                  "is_oscillating": {
                    "type": "boolean",
                    "description": "True if file shows back-and-forth pattern (adds then reverts)"
                  }
                }
              }
            },
            "oscillations": {
              "type": "array",
              "description": "Detected patterns of back-and-forth changes indicating uncertainty or exploration",
              "items": {
                "type": "object",
                "required": ["type", "files", "commits", "evidence", "keywords"],
                "properties": {
                  "type": {
                    "type": "string",
                    "enum": ["dependency_flip", "schema_rename", "approach_flip", "revert_pattern"],
                    "description": "Oscillation category: dependency_flip (switching deps), schema_rename (naming changes), approach_flip (implementation changes), revert_pattern (explicit reverts)"
                  },
                  "files": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Files involved in this oscillation pattern"
                  },
                  "commits": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Commit SHAs involved in this oscillation pattern"
                  },
                  "evidence": {
                    "type": "string",
                    "description": "Human-readable explanation of the oscillation pattern"
                  },
                  "keywords": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Keywords or identifiers that triggered detection (e.g., 'revert', 'refactor', 'schema')"
                  }
                }
              }
            },
            "inflection_point": {
              "type": ["object", "null"],
              "description": "The commit where the PR shifted from exploration/oscillation to convergence (null if no clear inflection)",
              "properties": {
                "commit": {
                  "type": "string",
                  "description": "Commit SHA marking the inflection point"
                },
                "rationale": {
                  "type": "string",
                  "description": "Explanation of why this commit represents the inflection point"
                }
              },
              "required": ["commit", "rationale"]
            },
            "notes": {
              "type": "string",
              "description": "Human-readable summary of the temporal analysis"
            }
          }
        }
      }
    },
    "cost": {
      "type": "object",
      "properties": {
        "wall_clock": {
          "type": "object",
          "properties": {
            "days": {"type": "number"},
            "hours": {"type": "number"},
            "created_at": {"type": "string"},
            "merged_at": {"type": ["string", "null"]}
          }
        },
        "active_work_proxy": {
          "type": "object",
          "description": "Legacy proxy metric - kept for reference but not the headline metric. See devlt.control_plane for AI-native model.",
          "properties": {
            "lb_hours": {"type": "number"},
            "ub_hours": {"type": "number"},
            "method": {"type": "string"},
            "session_count": {"type": "integer"}
          }
        },
        "devlt": {
          "type": "object",
          "properties": {
            "author": {
              "type": "object",
              "properties": {
                "lb_minutes": {"type": "integer"},
                "ub_minutes": {"type": "integer"},
                "band": {"type": "string"}
              }
            },
            "review": {
              "type": "object",
              "properties": {
                "lb_minutes": {"type": "integer"},
                "ub_minutes": {"type": "integer"},
                "band": {"type": "string"}
              }
            },
            "control_plane": {
              "type": "object",
              "description": "Decision-weighted DevLT (AI-native model)",
              "properties": {
                "lb_minutes": {"type": "integer"},
                "ub_minutes": {"type": "integer"},
                "band": {"type": "string"},
                "method": {"type": "string"},
                "coverage": {"type": "string"},
                "decision_count": {"type": "integer"}
              }
            },
            "method": {"type": "string"}
          }
        },
        "machine_spend": {
          "type": "object",
          "properties": {
            "estimate_usd": {"type": ["number", "null"]},
            "band": {"type": "string"},
            "method": {"type": "string"},
            "notes": {"type": "string"}
          }
        }
      }
    },
    "reflection": {
      "type": "object",
      "properties": {
        "went_well": {
          "type": "array",
          "items": {"type": "string"}
        },
        "could_be_better": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "outcome": {
      "type": "string",
      "enum": ["shipped", "deferred", "rejected", "invalid_measurement", "pending"]
    },
    "factory_delta": {
      "type": "object",
      "properties": {
        "gates_added": {
          "type": "array",
          "items": {"type": "string"}
        },
        "contracts_added": {
          "type": "array",
          "items": {"type": "string"}
        },
        "prevention_issues": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "followups": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "issue": {"type": "string"},
          "description": {"type": "string"}
        }
      }
    }
  }
}
