name: Verify (slower-whisper-verify)

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Nightly full verify (UTC)
    - cron: "0 6 * * *"

concurrency:
  group: verify-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify-quick:
    name: Verify (quick)
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Restore uv cache
        uses: actions/cache/restore@v5
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-24.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Set up Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Run verification (quick)
        run: nix run .#verify -- --quick

      - name: Save uv cache
        if: always()
        continue-on-error: true
        uses: actions/cache/save@v5
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}

  verify-full:
    name: Verify (full)
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 150
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Restore uv cache
        uses: actions/cache/restore@v5
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Restore HuggingFace cache
        uses: actions/cache/restore@v5
        with:
          path: ~/.cache/huggingface
          key: hf-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            hf-${{ runner.os }}-

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-24.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Set up Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Sync dependencies (dev + diarization + full extras)
        run: nix develop .# --command uv sync --extra full --extra diarization --extra dev

      - name: Run verification (full)
        run: nix develop .# --command uv run slower-whisper-verify

      - name: Save uv cache
        if: always()
        continue-on-error: true
        uses: actions/cache/save@v5
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}

      - name: Save HuggingFace cache
        if: always()
        continue-on-error: true
        uses: actions/cache/save@v5
        with:
          path: ~/.cache/huggingface
          key: hf-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}

  verify-api:
    name: Verify (API surface)
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Restore uv cache
        uses: actions/cache/restore@v5
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-24.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Set up Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Sync dependencies (dev + api extras)
        run: nix develop .# --command uv sync --extra api --extra dev

      - name: Run API verification
        run: nix develop .# --command uv run slower-whisper-verify --api

      - name: Save uv cache
        if: always()
        continue-on-error: true
        uses: actions/cache/save@v5
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
