# GitHub Issues for v1.1.0 Release

This document contains issue templates for the v1.1.0 speaker diarization milestone.

**Instructions:** Copy each issue into GitHub with the specified labels and milestone.

---

## Issue 1: Implement pyannote.audio integration for speaker diarization

**Labels:** `enhancement`, `v1.1`, `diarization`
**Milestone:** v1.1.0
**Assignee:** TBD

### Description

Implement the pyannote.audio diarization pipeline in `transcription/diarization.py::Diarizer.run()`.

### Acceptance Criteria

- [ ] Add `pyannote.audio>=3.1.0` to optional dependencies (`[diarization]` extra)
- [ ] Implement `Diarizer.run()` method:
  - Load pyannote pipeline (lazy init)
  - Support GPU/CPU device selection
  - Run diarization on 16kHz mono WAV
  - Convert pyannote output to `List[SpeakerTurn]`
  - Handle min/max speaker constraints
- [ ] GPU fallback to CPU on OOM
- [ ] Error handling (model download, invalid audio, etc.)
- [ ] Unit tests for `Diarizer` class
- [ ] Docstring updates

### Related Files

- `transcription/diarization.py` (currently skeleton)
- `pyproject.toml` (add dependencies)

### References

- pyannote.audio docs: https://github.com/pyannote/pyannote-audio
- Design doc: `docs/SPEAKER_DIARIZATION.md`

---

## Issue 2: Implement speaker-to-segment assignment

**Labels:** `enhancement`, `v1.1`, `diarization`
**Milestone:** v1.1.0
**Assignee:** TBD

### Description

Implement `assign_speakers_to_segments()` in `transcription/diarization.py` to map diarization output to ASR segments.

### Acceptance Criteria

- [ ] Implement overlap-based assignment logic (IoU or duration threshold)
- [ ] Build `SpeakerInfo` aggregates (total_speech_time, num_segments, confidence_mean)
- [ ] Handle ambiguous cases (overlap < threshold → speaker = null)
- [ ] Populate `transcript.speakers` and `segment.speaker` fields
- [ ] Unit tests with synthetic data (2 speakers, perfect overlap)
- [ ] Edge case tests (no overlap, partial overlap, single speaker)
- [ ] Docstring updates

### Related Files

- `transcription/diarization.py::assign_speakers_to_segments()`
- `transcription/models.py` (Transcript, Segment dataclasses)

### References

- Design doc: `docs/SPEAKER_DIARIZATION.md`
- Schema examples: `transcription/models.py`

---

## Issue 3: Implement basic turn building

**Labels:** `enhancement`, `v1.1`, `diarization`
**Milestone:** v1.1.0
**Assignee:** TBD

### Description

Implement `build_turns()` in `transcription/turns.py` to group contiguous segments by speaker into conversational turns.

### Acceptance Criteria

- [ ] Implement basic turn grouping (contiguous segments, same speaker)
- [ ] Optionally split on long pauses (configurable threshold)
- [ ] Populate `Turn` dataclass with (speaker_id, start, end, segment_ids, text)
- [ ] Add `turns[]` to transcript schema
- [ ] Unit tests with synthetic multi-turn data (A-B-A-B pattern)
- [ ] Edge case tests (single speaker, no speakers, rapid turn switches)
- [ ] Docstring updates

### Related Files

- `transcription/turns.py::build_turns()` (currently skeleton)
- `transcription/models.py` (add `turns` field to Transcript)

### References

- Design doc: `docs/SPEAKER_DIARIZATION.md`
- Testing strategy: `docs/TESTING_STRATEGY.md` (Layer 2: Turn Structure)

---

## Issue 4: Wire diarization into transcription pipeline

**Labels:** `enhancement`, `v1.1`, `diarization`, `integration`
**Milestone:** v1.1.0
**Assignee:** TBD

### Description

Integrate diarization into the main transcription pipeline (`api.py::transcribe_directory()`).

### Acceptance Criteria

- [ ] Check `--enable-diarization` flag in `transcribe_directory()`
- [ ] After ASR completes, run `Diarizer.run()` on normalized WAV
- [ ] Call `assign_speakers_to_segments()` to populate speaker fields
- [ ] Call `build_turns()` to populate turns array
- [ ] Update transcript object and save to JSON
- [ ] Graceful degradation on diarization errors (log warning, continue with null speakers)
- [ ] Integration test with synthetic 2-speaker audio
- [ ] End-to-end test via CLI (`uv run slower-whisper transcribe --enable-diarization`)

### Related Files

- `transcription/api.py::transcribe_directory()`
- `transcription/cli.py` (already has `--enable-diarization` flag)
- `transcription/diarization.py`
- `transcription/turns.py`

### References

- Design doc: `docs/SPEAKER_DIARIZATION.md` (Data Flow section)

---

## Issue 5: Generate synthetic 2-speaker test audio

**Labels:** `testing`, `v1.1`, `diarization`
**Milestone:** v1.1.0
**Assignee:** TBD

### Description

Create `tests/fixtures/synthetic_2speaker.wav` for BDD testing of diarization.

### Acceptance Criteria

- [ ] Generate 12-second audio with 2 distinct speakers (TTS-based)
  - 0.0–3.0s: Speaker A (male voice, low pitch)
  - 3.2–6.0s: Speaker B (female voice, high pitch)
  - 6.2–9.0s: Speaker A
  - 9.2–12.0s: Speaker B
- [ ] Save as 16kHz mono WAV
- [ ] Script: `tests/fixtures/generate_synthetic_2speaker.py`
- [ ] Document expected output in script (2 speakers, A-B-A-B, DER=0.00)
- [ ] Add to `.gitignore` or commit fixture (TBD based on size)

### Related Files

- `tests/fixtures/generate_synthetic_2speaker.py` (new)
- `tests/fixtures/synthetic_2speaker.wav` (generated)

### References

- Testing strategy: `docs/TESTING_STRATEGY.md` (MVP Testbed section)
- Design doc: `docs/SPEAKER_DIARIZATION.md`

---

## Issue 6: Add BDD scenarios for diarization

**Labels:** `testing`, `v1.1`, `diarization`, `BDD`
**Milestone:** v1.1.0
**Assignee:** TBD

### Description

Implement BDD step definitions for speaker diarization scenarios in `tests/features/transcription.feature`.

### Acceptance Criteria

- [ ] Implement step: "When I transcribe the project with diarization enabled"
- [ ] Implement step: "Then exactly N speakers are detected"
- [ ] Implement step: "And all segment 'speaker' values are null or valid speaker IDs"
- [ ] Implement step: "And speaker labels alternate A-B-A-B"
- [ ] Implement step: "And if 'speakers' array exists, each speaker has required fields"
- [ ] All 3 new BDD scenarios pass (from `transcription.feature`)
- [ ] Update `tests/steps/test_transcription.py` with new steps

### Related Files

- `tests/features/transcription.feature` (scenarios already added)
- `tests/steps/test_transcription.py` (add step definitions)

### References

- BDD scenarios: `tests/features/transcription.feature:52-73`

---

## Issue 7: Add per-speaker prosody baselines (optional for v1.1)

**Labels:** `enhancement`, `v1.1`, `diarization`, `prosody`, `optional`
**Milestone:** v1.1.0 (optional)
**Assignee:** TBD

### Description

Extend `audio_enrichment.py` to compute per-speaker prosody baselines instead of global baselines.

### Acceptance Criteria

- [ ] Detect if `segment.speaker` is populated
- [ ] Group segments by speaker before computing baselines
- [ ] Compute per-speaker median pitch, energy, rate
- [ ] Use speaker-specific baseline for prosody categorization
- [ ] Fallback to global baseline if speaker = null
- [ ] Unit tests with 2-speaker synthetic data (different pitch ranges)
- [ ] BDD scenario: "Speaker A at 160 Hz labeled 'high pitch' vs their 120 Hz baseline"

### Related Files

- `transcription/audio_enrichment.py::compute_baseline()`
- `transcription/prosody.py`

### References

- Testing strategy: `docs/TESTING_STRATEGY.md` (Per-Speaker Baseline Test)

### Notes

This is **optional for v1.1**. Can defer to v1.2 if time is limited. Mark as "won't fix" for v1.1 if deferred.

---

## Issue 8: Update documentation for v1.1 speaker features

**Labels:** `documentation`, `v1.1`
**Milestone:** v1.1.0
**Assignee:** TBD

### Description

Update all user-facing documentation to reflect v1.1 speaker diarization features.

### Acceptance Criteria

- [ ] Update README.md with `--enable-diarization` flag and example usage
- [ ] Update ARCHITECTURE.md with diarization data flow
- [ ] Update CLAUDE.md with v1.1 priorities and design constraints
- [ ] Update ROADMAP.md to mark v1.1 as complete (when shipped)
- [ ] Update CHANGELOG.md with v1.1 release notes
- [ ] Add example JSON output with `speakers` and `turns` arrays to README
- [ ] Add "Known Limitations" section (DER threshold, no word-level alignment)

### Related Files

- `README.md`
- `docs/ARCHITECTURE.md`
- `CLAUDE.md`
- `docs/ROADMAP.md`
- `CHANGELOG.md`

### References

- Design doc: `docs/SPEAKER_DIARIZATION.md` (Schema Impact, Configuration sections)

---

## Issue 9: Add AMI dataset evaluation benchmark (v1.2 follow-up)

**Labels:** `testing`, `v1.2`, `diarization`, `benchmark`
**Milestone:** v1.2.0
**Assignee:** TBD

### Description

Build evaluation harness for real-world diarization quality on AMI Meeting Corpus subset.

**Note:** This is a **v1.2 task**, not required for v1.1. Create issue now for tracking.

### Acceptance Criteria

- [ ] Acquire AMI Meeting Corpus subset (5-10 excerpts, 30-60s)
- [ ] Create `benchmarks/eval_diarization.py` script
- [ ] Compute DER (Diarization Error Rate)
- [ ] Measure speaker count accuracy
- [ ] Measure segment attribution F1
- [ ] Generate report with confusion matrix and failure mode analysis
- [ ] Target: DER < 0.25

### Related Files

- `benchmarks/eval_diarization.py` (new)
- `benchmarks/datasets/ami_subset/` (new)

### References

- Testing strategy: `docs/TESTING_STRATEGY.md` (MVP Testbed - AMI section)
- Design doc: `docs/SPEAKER_DIARIZATION.md` (Real-World Validation)

---

## Milestone Summary

**v1.1.0: Speaker Foundation**

**Required Issues (Blocking):**
1. Implement pyannote.audio integration (#1)
2. Implement speaker-to-segment assignment (#2)
3. Implement basic turn building (#3)
4. Wire diarization into pipeline (#4)
5. Generate synthetic 2-speaker test (#5)
6. Add BDD scenarios (#6)
7. Update documentation (#8)

**Optional Issues (Nice-to-Have):**
8. Per-speaker prosody baselines (#7) — defer to v1.2 if needed

**Future Issues (v1.2):**
9. AMI dataset evaluation (#9) — create now, schedule for v1.2

**Estimated Timeline:**
- Phase 1 (skeleton): Complete ✅
- Phase 2 (pyannote + assignment): 2-3 weeks
- Phase 3 (turn building): 1 week
- Phase 4 (integration + testing): 1 week
- Phase 5 (docs + polish): 1 week

**Total: 5-7 weeks → Target Q1 2026**

---

**Created:** 2025-11-17
**Last Updated:** 2025-11-17
