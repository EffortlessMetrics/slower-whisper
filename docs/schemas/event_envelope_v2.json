{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://slower-whisper.dev/schemas/event_envelope_v2.json",
  "title": "EventEnvelope",
  "description": "Server-to-client event envelope for WebSocket streaming protocol v2.0. Every server message uses this envelope format to provide consistent metadata for event ordering, timing, and context.",
  "type": "object",
  "required": ["event_id", "stream_id", "type", "ts_server", "payload"],
  "properties": {
    "event_id": {
      "type": "integer",
      "minimum": 1,
      "description": "Monotonically increasing event ID per stream. Never resets within a session. Gaps indicate dropped events (PARTIAL under backpressure)."
    },
    "stream_id": {
      "type": "string",
      "pattern": "^str-[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Unique stream identifier in format str-{uuid4}. Globally unique across all streams, immutable for session duration."
    },
    "segment_id": {
      "type": ["string", "null"],
      "pattern": "^seg-\\d+$",
      "description": "Segment identifier in format seg-{seq}. Null for non-segment events (SESSION_STARTED, SESSION_ENDED, PONG, etc.). Same segment_id links PARTIAL events to their FINALIZED event."
    },
    "type": {
      "$ref": "#/$defs/ServerMessageType",
      "description": "Server message type indicating the event category."
    },
    "ts_server": {
      "type": "integer",
      "minimum": 0,
      "description": "Server timestamp in Unix epoch milliseconds when the event was generated."
    },
    "ts_audio_start": {
      "type": ["number", "null"],
      "minimum": 0,
      "description": "Audio timestamp start in seconds. Null for non-audio events (SESSION_STARTED, PONG, etc.)."
    },
    "ts_audio_end": {
      "type": ["number", "null"],
      "minimum": 0,
      "description": "Audio timestamp end in seconds. Null for non-audio events."
    },
    "payload": {
      "type": "object",
      "description": "Event-type-specific payload. Schema depends on the 'type' field."
    }
  },
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": { "type": { "const": "SESSION_STARTED" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/SessionStartedPayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "SESSION_ENDED" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/SessionEndedPayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "PARTIAL" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/PartialPayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "FINALIZED" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/FinalizedPayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "SPEAKER_TURN" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/SpeakerTurnPayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "SEMANTIC_UPDATE" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/SemanticUpdatePayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "DIARIZATION_UPDATE" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/DiarizationUpdatePayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "ERROR" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/ErrorPayload" }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "PONG" } }
      },
      "then": {
        "properties": {
          "payload": { "$ref": "#/$defs/PongPayload" }
        }
      }
    }
  ],
  "$defs": {
    "ServerMessageType": {
      "type": "string",
      "enum": [
        "SESSION_STARTED",
        "PARTIAL",
        "FINALIZED",
        "SPEAKER_TURN",
        "SEMANTIC_UPDATE",
        "DIARIZATION_UPDATE",
        "ERROR",
        "SESSION_ENDED",
        "PONG"
      ],
      "description": "Server message types sent from server to client."
    },
    "SessionStartedPayload": {
      "type": "object",
      "required": ["session_id"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "The stream_id for this session (same as envelope stream_id)."
        }
      },
      "additionalProperties": false,
      "description": "Payload for SESSION_STARTED events. Confirms session initialization."
    },
    "SessionEndedPayload": {
      "type": "object",
      "required": ["stats"],
      "properties": {
        "stats": {
          "$ref": "#/$defs/SessionStats",
          "description": "Session statistics summarizing the completed stream."
        }
      },
      "additionalProperties": false,
      "description": "Payload for SESSION_ENDED events. Contains final session statistics."
    },
    "SessionStats": {
      "type": "object",
      "required": [
        "chunks_received",
        "bytes_received",
        "segments_partial",
        "segments_finalized",
        "events_sent",
        "events_dropped",
        "errors",
        "duration_sec"
      ],
      "properties": {
        "chunks_received": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of audio chunks received."
        },
        "bytes_received": {
          "type": "integer",
          "minimum": 0,
          "description": "Total bytes of audio data received."
        },
        "segments_partial": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of PARTIAL segment events emitted."
        },
        "segments_finalized": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of FINALIZED segment events emitted."
        },
        "events_sent": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of events sent to client."
        },
        "events_dropped": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of events dropped due to backpressure."
        },
        "errors": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of errors encountered during session."
        },
        "duration_sec": {
          "type": "number",
          "minimum": 0,
          "description": "Session duration in seconds."
        }
      },
      "additionalProperties": false,
      "description": "Statistics tracked for a WebSocket streaming session."
    },
    "PartialPayload": {
      "type": "object",
      "required": ["segment"],
      "properties": {
        "segment": {
          "$ref": "#/$defs/PartialSegment",
          "description": "The in-progress segment data."
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "ASR confidence score (0.0-1.0). Optional."
        }
      },
      "additionalProperties": false,
      "description": "Payload for PARTIAL events. Text may change with subsequent updates."
    },
    "PartialSegment": {
      "type": "object",
      "required": ["start", "end", "text"],
      "properties": {
        "start": {
          "type": "number",
          "minimum": 0,
          "description": "Segment start time in seconds."
        },
        "end": {
          "type": "number",
          "minimum": 0,
          "description": "Current segment end time in seconds."
        },
        "text": {
          "type": "string",
          "description": "Current transcribed text (may change)."
        },
        "speaker_id": {
          "type": ["string", "null"],
          "description": "Speaker identifier, null if not available."
        }
      },
      "additionalProperties": false,
      "description": "Segment data for PARTIAL events."
    },
    "FinalizedPayload": {
      "type": "object",
      "required": ["segment"],
      "properties": {
        "segment": {
          "$ref": "#/$defs/FinalizedSegment",
          "description": "The finalized segment data."
        }
      },
      "additionalProperties": false,
      "description": "Payload for FINALIZED events. Text is immutable after this event."
    },
    "FinalizedSegment": {
      "type": "object",
      "required": ["start", "end", "text"],
      "properties": {
        "start": {
          "type": "number",
          "minimum": 0,
          "description": "Final segment start time in seconds."
        },
        "end": {
          "type": "number",
          "minimum": 0,
          "description": "Final segment end time in seconds."
        },
        "text": {
          "type": "string",
          "description": "Final transcribed text (immutable)."
        },
        "speaker_id": {
          "type": ["string", "null"],
          "description": "Speaker identifier."
        },
        "audio_state": {
          "type": ["object", "null"],
          "$ref": "#/$defs/AudioState",
          "description": "Audio enrichment data. Null if enrichment not enabled or failed."
        }
      },
      "additionalProperties": false,
      "description": "Segment data for FINALIZED events."
    },
    "AudioState": {
      "type": ["object", "null"],
      "properties": {
        "prosody": {
          "type": "object",
          "properties": {
            "pitch": {
              "type": "object",
              "properties": {
                "level": {
                  "type": "string",
                  "enum": ["low", "neutral", "high"],
                  "description": "Pitch level classification."
                },
                "mean_hz": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Mean pitch in Hz."
                }
              },
              "additionalProperties": true
            },
            "energy": {
              "type": "object",
              "properties": {
                "level": {
                  "type": "string",
                  "enum": ["quiet", "moderate", "loud"],
                  "description": "Energy/volume level classification."
                },
                "mean_db": {
                  "type": "number",
                  "description": "Mean energy in dB."
                }
              },
              "additionalProperties": true
            },
            "rate": {
              "type": "object",
              "properties": {
                "level": {
                  "type": "string",
                  "enum": ["slow", "moderate", "fast"],
                  "description": "Speech rate classification."
                },
                "syllables_per_sec": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Syllables per second."
                }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true,
          "description": "Prosodic features extracted from audio."
        },
        "emotion": {
          "type": "object",
          "properties": {
            "valence": {
              "type": "object",
              "properties": {
                "level": {
                  "type": "string",
                  "enum": ["negative", "neutral", "positive"],
                  "description": "Valence classification."
                },
                "score": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1,
                  "description": "Valence score (0.0-1.0)."
                }
              },
              "additionalProperties": true
            },
            "arousal": {
              "type": "object",
              "properties": {
                "level": {
                  "type": "string",
                  "enum": ["low", "moderate", "high"],
                  "description": "Arousal classification."
                },
                "score": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1,
                  "description": "Arousal score (0.0-1.0)."
                }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true,
          "description": "Dimensional emotion features."
        },
        "categorical_emotion": {
          "type": "object",
          "properties": {
            "label": {
              "type": "string",
              "description": "Categorical emotion label (e.g., 'happy', 'sad', 'angry')."
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Classification confidence (0.0-1.0)."
            }
          },
          "additionalProperties": true,
          "description": "Categorical emotion classification."
        },
        "rendering": {
          "type": "string",
          "description": "Human-readable rendering of audio state (e.g., '[audio: high pitch, positive]')."
        }
      },
      "additionalProperties": true,
      "description": "Audio enrichment data including prosody, emotion, and rendering."
    },
    "SpeakerTurnPayload": {
      "type": "object",
      "required": ["turn"],
      "properties": {
        "turn": {
          "$ref": "#/$defs/Turn",
          "description": "The finalized speaker turn."
        },
        "previous_speaker": {
          "type": ["string", "null"],
          "description": "Previous speaker ID. Null for first turn."
        }
      },
      "additionalProperties": false,
      "description": "Payload for SPEAKER_TURN events. Emitted at speaker change or significant pause."
    },
    "Turn": {
      "type": "object",
      "required": ["id", "speaker_id", "start", "end", "segment_ids", "text"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^turn-\\d+$",
          "description": "Turn identifier in format turn-{seq}."
        },
        "speaker_id": {
          "type": "string",
          "description": "Speaker identifier for this turn."
        },
        "start": {
          "type": "number",
          "minimum": 0,
          "description": "Turn start time in seconds."
        },
        "end": {
          "type": "number",
          "minimum": 0,
          "description": "Turn end time in seconds."
        },
        "segment_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^seg-\\d+$"
          },
          "description": "List of segment IDs comprising this turn."
        },
        "text": {
          "type": "string",
          "description": "Concatenated text from all segments in the turn."
        }
      },
      "additionalProperties": false,
      "description": "A speaker turn containing one or more segments."
    },
    "SemanticUpdatePayload": {
      "type": "object",
      "required": ["turn_id", "keywords", "risk_tags", "actions", "question_count", "context_size"],
      "properties": {
        "turn_id": {
          "type": "string",
          "pattern": "^turn-\\d+$",
          "description": "Reference to the annotated turn."
        },
        "keywords": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Extracted keywords and key phrases."
        },
        "risk_tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Risk indicators (e.g., 'churn_risk', 'escalation', 'compliance_flag')."
        },
        "actions": {
          "type": "array",
          "items": { "$ref": "#/$defs/ActionItem" },
          "description": "Detected action items and commitments."
        },
        "question_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of questions detected in the turn."
        },
        "intent": {
          "type": "string",
          "description": "Classified intent (e.g., 'greeting', 'complaint', 'inquiry'). Optional."
        },
        "sentiment": {
          "type": "string",
          "enum": ["negative", "neutral", "positive"],
          "description": "Overall sentiment classification. Optional."
        },
        "context_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Current size of the context window (number of turns)."
        }
      },
      "additionalProperties": false,
      "description": "Payload for SEMANTIC_UPDATE events. Contains semantic annotations for a finalized turn."
    },
    "ActionItem": {
      "type": "object",
      "required": ["text", "pattern"],
      "properties": {
        "text": {
          "type": "string",
          "description": "The action item text."
        },
        "pattern": {
          "type": "string",
          "description": "Detection pattern type (e.g., 'imperative', 'commitment', 'request')."
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Detection confidence (0.0-1.0). Optional."
        }
      },
      "additionalProperties": false,
      "description": "A detected action item or commitment."
    },
    "DiarizationUpdatePayload": {
      "type": "object",
      "required": ["update_number", "audio_duration", "num_speakers", "speaker_ids", "assignments"],
      "properties": {
        "update_number": {
          "type": "integer",
          "minimum": 1,
          "description": "Sequential update number for this stream."
        },
        "audio_duration": {
          "type": "number",
          "minimum": 0,
          "description": "Total audio duration processed in seconds."
        },
        "num_speakers": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of unique speakers detected."
        },
        "speaker_ids": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Sorted list of unique speaker identifiers."
        },
        "assignments": {
          "type": "array",
          "items": { "$ref": "#/$defs/SpeakerAssignment" },
          "description": "Speaker assignments for time ranges."
        }
      },
      "additionalProperties": false,
      "description": "Payload for DIARIZATION_UPDATE events. Contains incremental speaker diarization results."
    },
    "SpeakerAssignment": {
      "type": "object",
      "required": ["start", "end", "speaker_id"],
      "properties": {
        "start": {
          "type": "number",
          "minimum": 0,
          "description": "Start time in seconds."
        },
        "end": {
          "type": "number",
          "minimum": 0,
          "description": "End time in seconds."
        },
        "speaker_id": {
          "type": "string",
          "description": "Speaker identifier (e.g., 'spk_0', 'SPEAKER_00')."
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Assignment confidence score (0.0-1.0). Optional."
        }
      },
      "additionalProperties": false,
      "description": "Speaker assignment for a time range."
    },
    "ErrorPayload": {
      "type": "object",
      "required": ["code", "message", "recoverable"],
      "properties": {
        "code": {
          "type": "string",
          "enum": [
            "ASR_TIMEOUT",
            "ASR_FAILURE",
            "ENRICHMENT_FAILURE",
            "SEQUENCE_ERROR",
            "BUFFER_OVERFLOW",
            "RESUME_GAP",
            "SESSION_ERROR",
            "INVALID_MESSAGE",
            "RATE_LIMITED",
            "DIARIZATION_FAILURE"
          ],
          "description": "Error code identifier."
        },
        "message": {
          "type": "string",
          "description": "Human-readable error description."
        },
        "recoverable": {
          "type": "boolean",
          "description": "Whether the client can continue after this error. If false, client should close connection."
        },
        "details": {
          "type": "object",
          "additionalProperties": true,
          "description": "Additional error-specific context. Schema varies by error code."
        }
      },
      "additionalProperties": false,
      "description": "Payload for ERROR events. Contains error information and recovery guidance."
    },
    "PongPayload": {
      "type": "object",
      "required": ["timestamp", "server_timestamp"],
      "properties": {
        "timestamp": {
          "type": "integer",
          "description": "Client timestamp from the original PING message (echo)."
        },
        "server_timestamp": {
          "type": "integer",
          "description": "Server timestamp in Unix epoch milliseconds when PONG was generated."
        }
      },
      "additionalProperties": false,
      "description": "Payload for PONG events. Used for latency measurement and keep-alive."
    }
  }
}
